{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block title %}Search - {{ site_title }}{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">{% trans 'Home' %}</a>
    &rsaquo; Search
</div>
{% endblock %}

{% block content %}
<h1>Search ScientaGrid</h1>

<form method="get" action="">
    <div style="margin-bottom: 20px;">
        <input type="text" name="q" value="{{ query|default:'' }}" placeholder="Search..." style="width: 400px; padding: 8px;" autofocus>
        
        <select name="type" style="padding: 8px;">
            <option value="unified" {% if search_type == 'unified' %}selected{% endif %}>All Types</option>
            <option value="infrastructure" {% if search_type == 'infrastructure' %}selected{% endif %}>Infrastructures</option>
            <option value="equipment" {% if search_type == 'equipment' %}selected{% endif %}>Equipment</option>
            <option value="service" {% if search_type == 'service' %}selected{% endif %}>Services</option>
        </select>
        
        <input type="submit" value="Search" class="button" style="padding: 8px 20px;">
    </div>
</form>

{% if query %}
    <h2>Search Results for "{{ query }}"</h2>
    
    {% if results %}
        {# Unified search results #}
        {% if 'infrastructures' in results %}
            <h3>Infrastructures ({{ results.infrastructures.count }} found in {{ results.infrastructures.time_ms }}ms)</h3>
            {% if results.infrastructures.results %}
                <ul>
                {% for obj in results.infrastructures.results %}
                    <li>
                        <a href="{% url 'admin:infrastructures_infrastructure_change' obj.id %}"><strong>{{ obj.name }}</strong></a>
                        {% if obj.city %}- {{ obj.city.name }}{% endif %}
                        {% if obj.description %}
                            <br><small>{{ obj.description|truncatewords:30 }}</small>
                        {% endif %}
                    </li>
                {% endfor %}
                </ul>
            {% else %}
                <p><em>No infrastructures found.</em></p>
            {% endif %}
        {% endif %}

        {% if 'equipment' in results %}
            <h3>Equipment ({{ results.equipment.count }} found in {{ results.equipment.time_ms }}ms)</h3>
            {% if results.equipment.results %}
                <ul>
                {% for obj in results.equipment.results %}
                    <li>
                        <a href="{% url 'admin:equipment_equipment_change' obj.id %}"><strong>{{ obj.name }}</strong></a>
                        {% if obj.infrastructure %}at {{ obj.infrastructure.name }}{% endif %}
                        {% if obj.description %}
                            <br><small>{{ obj.description|truncatewords:30 }}</small>
                        {% endif %}
                    </li>
                {% endfor %}
                </ul>
            {% else %}
                <p><em>No equipment found.</em></p>
            {% endif %}
        {% endif %}

        {% if 'services' in results %}
            <h3>Services ({{ results.services.count }} found in {{ results.services.time_ms }}ms)</h3>
            {% if results.services.results %}
                <ul>
                {% for obj in results.services.results %}
                    <li>
                        <a href="{% url 'admin:services_service_change' obj.id %}"><strong>{{ obj.name }}</strong></a>
                        {% if obj.code %}<small>({{ obj.code }})</small>{% endif %}
                        {% if obj.description %}
                            <br><small>{{ obj.description|truncatewords:30 }}</small>
                        {% endif %}
                    </li>
                {% endfor %}
                </ul>
            {% else %}
                <p><em>No services found.</em></p>
            {% endif %}
        {% endif %}

        {% if 'research_problems' in results %}
            <h3>Research Problems ({{ results.research_problems.count }} found in {{ results.research_problems.time_ms }}ms)</h3>
            {% if results.research_problems.results %}
                <ul>
                {% for obj in results.research_problems.results %}
                    <li>
                        <a href="{% url 'admin:research_problems_researchproblem_change' obj.id %}"><strong>{{ obj.title }}</strong></a>
                        {% if obj.status %}<small>({{ obj.get_status_display }})</small>{% endif %}
                        {% if obj.description %}
                            <br><small>{{ obj.description|truncatewords:30 }}</small>
                        {% endif %}
                    </li>
                {% endfor %}
                </ul>
            {% else %}
                <p><em>No research problems found.</em></p>
            {% endif %}
        {% endif %}
    {% elif infrastructures %}
        <p>Found {{ count }} infrastructure(s) in {{ time_ms }}ms</p>
        <ul>
        {% for infra in infrastructures %}
            <li>
                <a href="{% url 'admin:infrastructures_infrastructure_change' infra.id %}"><strong>{{ infra.name }}</strong></a>
                {% if infra.city %}- {{ infra.city.name }}{% endif %}
                {% if infra.description %}
                    <br><small>{{ infra.description|truncatewords:30 }}</small>
                {% endif %}
            </li>
        {% endfor %}
        </ul>
    {% elif equipment %}
        <p>Found {{ count }} equipment in {{ time_ms }}ms</p>
        <ul>
        {% for eq in equipment %}
            <li>
                <a href="{% url 'admin:equipment_equipment_change' eq.id %}"><strong>{{ eq.name }}</strong></a>
                {% if eq.infrastructure %}at {{ eq.infrastructure.name }}{% endif %}
                {% if eq.description %}
                    <br><small>{{ eq.description|truncatewords:30 }}</small>
                {% endif %}
            </li>
        {% endfor %}
        </ul>
    {% elif services %}
        <p>Found {{ count }} service(s) in {{ time_ms }}ms</p>
        <ul>
        {% for svc in services %}
            <li>
                <a href="{% url 'admin:services_service_change' svc.id %}"><strong>{{ svc.name }}</strong></a>
                {% if svc.code %}<small>({{ svc.code }})</small>{% endif %}
                {% if svc.description %}
                    <br><small>{{ svc.description|truncatewords:30 }}</small>
                {% endif %}
            </li>
        {% endfor %}
        </ul>
    {% else %}
        <p><em>No results found.</em></p>
    {% endif %}
{% endif %}

{% endblock %}